import { FC, ReactNode, ReactElement } from 'react'
import { ApolloQueryResult, OperationVariables } from '@apollo/client'
import { getFiltersOfKind, FilterLink, SearchSidebar, SearchSidebarSection, CodeHostIcon } from '@sourcegraph/branded'
import { displayRepoName } from '@sourcegraph/shared/src/components/RepoLink'
import { SectionID } from '@sourcegraph/shared/src/settings/temporary/searchSidebar'
import { FilterType } from '@sourcegraph/shared/src/search/query/filters'
import { VulnerabilityMatchesResult } from '../../../../graphql-operations'
import styles from './VulnerabilitySidebar.module.scss'

export interface VulnerabilitySidebarProps {
    onShowMobileFiltersChanged: () => void
    onFilterChosen: (
        variables?: Partial<OperationVariables> | undefined
    ) => Promise<ApolloQueryResult<VulnerabilityMatchesResult>>
}

// TODO: add react memo
export const VulnerabilitySidebarView: FC<VulnerabilitySidebarProps> = ({
    onShowMobileFiltersChanged,
    onFilterChosen,
}) => {
    const mockFilters = [
        {
            value: 'github.com/sourcegraph/sourcegraph',
            label: 'github.com/sourcegraph/sourcegraph',
            count: 1,
            limitHit: false,
            kind: 'repo',
        },
        {
            value: 'github.com/test1/test1',
            label: 'github.com/test1/test1',
            count: 1,
            limitHit: false,
            kind: 'repo',
        },
        {
            value: 'github.com/etcd/etcd',
            label: 'github.com/etcd/etcd',
            count: 1,
            limitHit: false,
            kind: 'repo',
        },
        {
            value: 'github.com/hashicorp/hashicorp',
            label: 'github.com/hashicorp/hashicorp',
            count: 1,
            limitHit: false,
            kind: 'repo',
        },
    ]

    return (
        <SearchSidebar onClose={() => onShowMobileFiltersChanged()} className={styles.sidebarContainer}>
            <SearchSidebarSection sectionId={SectionID.SEVERITY} header="Severity" minItems={4}>
                <FilterLink
                    value="Critical"
                    label="critical"
                    onFilterChosen={() => onFilterChosen({ severity: 'CRITICAL' })}
                />
                <FilterLink value="High" label="high" onFilterChosen={() => onFilterChosen({ severity: 'HIGH' })} />
                <FilterLink
                    value="Medium"
                    label="medium"
                    onFilterChosen={() => onFilterChosen({ severity: 'MEDIUM' })}
                />
                <FilterLink value="Low" label="low" onFilterChosen={() => onFilterChosen({ severity: 'LOW' })} />
            </SearchSidebarSection>

            <SearchSidebarSection sectionId={SectionID.STATUS} header="Status" minItems={3}>
                <FilterLink value="Open" label="open" onFilterChosen={() => console.log('chose open')} />
                <FilterLink value="Ignored" label="ignored" onFilterChosen={() => console.log('chose ignored')} />
                <FilterLink value="Resolved" label="resolved" onFilterChosen={() => console.log('chose resolved')} />
            </SearchSidebarSection>

            <SearchSidebarSection sectionId={SectionID.LANGUAGES} header="Languages" minItems={2}>
                <FilterLink value="lang:go" label="golang" onFilterChosen={() => console.log('chose lang go')} />
                <FilterLink value="lang:java" label="java" onFilterChosen={() => console.log('chose lang java')} />
            </SearchSidebarSection>

            <SearchSidebarSection
                sectionId={SectionID.REPOSITORIES}
                header="Repositories"
                searchOptions={{
                    ariaLabel: 'Find repositories',
                    noResultText: getRepoFilterNoResultText,
                }}
                minItems={1}
            >
                {getRepoFilterLinks(mockFilters, el => console.log('clicked', el))}
            </SearchSidebarSection>
        </SearchSidebar>
    )
}

const getRepoFilterNoResultText = (repoFilterLinks: ReactElement[]): ReactNode => (
    <span>None of the top {repoFilterLinks.length} repositories in your results match this filter.</span>
)

export const getRepoFilterLinks = (
    filters: any | undefined,
    onFilterChosen: (value: string, kind?: string) => void
): React.ReactElement[] => {
    function repoLabelConverter(label: string): JSX.Element {
        const Icon = CodeHostIcon({
            repoName: label,
            className: styles.sidebarSectionIcon,
        })

        return (
            <span className={styles.sidebarSectionListItemBreakWords}>
                {Icon ? (
                    <>
                        {Icon}
                        {displayRepoName(label)}
                    </>
                ) : (
                    label
                )}
            </span>
        )
    }

    return getFiltersOfKind(filters, FilterType.repo).map(filter => (
        <FilterLink
            {...filter}
            key={`${filter.label}-${filter.value}`}
            labelConverter={repoLabelConverter}
            onFilterChosen={onFilterChosen}
            ariaLabel={`Search in repository ${filter.label}`}
        />
    ))
}
