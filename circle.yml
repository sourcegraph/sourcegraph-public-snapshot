machine:
  services:
    - docker
    - postgresql
  environment:
    REPO: ../.go_workspace/src/src.sourcegraph.com/sourcegraph
    PGUSER: ubuntu
    PGDATABASE: circle_test
    PGSSLMODE: disable
    PATH: $HOME/protobuf/bin:$HOME/google-cloud-sdk/bin:$PATH
    LD_LIBRARY_PATH: $HOME/protobuf/lib
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    LONG_VERSION: $(printf %05d $CIRCLE_BUILD_NUM)_$(date +%Y-%m-%d)_${CIRCLE_SHA1:0:7}

    # Don't block on `git diff` invocations of `less`.
    GIT_PAGER:
  node:
    version: 4.1.0

dependencies:
  pre:
    # Use Go 1.6.
    - cd /usr/local && sudo rm -rf go && curl https://storage.googleapis.com/golang/go1.6.linux-amd64.tar.gz | sudo tar -xz && sudo chmod -R a+rwx /usr/local/go
    # Update git, curl, and libcurl ( both openssl and gnutls flavours )
    - sudo apt-get update; sudo apt-get install git curl libcurl3 libcurl3-gnutls

  cache_directories:
    - ~/protobuf
    - ~/google-cloud-sdk
    - ~/daemonize

  override:
    - rm -rf $HOME/.go_workspace/src
    - mkdir -p $HOME/.go_workspace/src/src.sourcegraph.com
    - cp -r $PWD $REPO

    - git --version
    - curl --version
    - curl-config --version

    - git config --global user.email "ci@example.com"
    - git config --global user.name "CI User"

    - if [ ! -d ~/protobuf ]; then $REPO/dev/install_protobuf.sh $PWD/build/ && mv ./build/usr/local $HOME/protobuf; fi
    - if [ ! -d ~/google-cloud-sdk ]; then curl https://sdk.cloud.google.com | bash; fi
    - if [ ! -d ~/daemonize ]; then mkdir ~/daemonize; package/linux/scripts/install_daemonize.sh ~/daemonize/; fi

test:
  override:
    - ./sh/gofmt.sh:
        pwd: $REPO
    - npm run dep:
        pwd: $REPO/app
    - npm test:
        pwd: $REPO/app
    - make check:
        pwd: $REPO
    - set -o pipefail; make mdtest TESTFLAGS="-test.v -test.timeout 5m" TESTPKGS="$(dev/circle-ci-split-pkgs.sh)" | tee $HOME/mdtest.out:
        pwd: $REPO
        parallel: true
    - make smoke:
        pwd: $REPO
  post:
    - grep '^FAIL' $HOME/mdtest.out || true:
        parallel: true

    - go get github.com/jstemmer/go-junit-report:
        parallel: true
    - mkdir -p $CIRCLE_TEST_REPORTS/junit:
        parallel: true
    - go-junit-report < $HOME/mdtest.out > $CIRCLE_TEST_REPORTS/junit/mdtest.xml:
        parallel: true

    - npm run graph:
        pwd: $REPO/app
    - cp $REPO/app/artifacts/* $CIRCLE_ARTIFACTS

deployment:
  master-branch:
    branch: master
    commands:
      - ./circle-build-docker-image.sh $LONG_VERSION:
          pwd: $REPO
      - docker tag us.gcr.io/sourcegraph-dev/sourcegraph:$LONG_VERSION us.gcr.io/sourcegraph-dev/sourcegraph:latest
      - gcloud docker push us.gcr.io/sourcegraph-dev/sourcegraph:latest
      - curl http://deploy-bot.sourcegraph.com/set-branch-version -F "token=$DEPLOY_BOT_TOKEN" -F "branch=master" -F "version=$LONG_VERSION"
      - echo $LONG_VERSION | gsutil cp - gs://sourcegraph-metadata/latest-successful-build

  staging-branch:
    branch: staging
    commands:
      - ./circle-build-docker-image.sh $LONG_VERSION:
          pwd: $REPO
      - curl http://deploy-bot.sourcegraph.com/set-branch-version -F "token=$DEPLOY_BOT_TOKEN" -F "branch=staging" -F "version=$LONG_VERSION"

  release-tag:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - grep "# $VERSION" release_notes.md # fail if version is not mentioned in release notes
      - ./circle-build-docker-image.sh $CIRCLE_TAG:
          pwd: $REPO

      # build and upload binary releases
      - sgtool release $CIRCLE_TAG --skip-package:
          pwd: $REPO

      # push to Docker Hub
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker tag us.gcr.io/sourcegraph-dev/sourcegraph:$CIRCLE_TAG sourcegraph/sourcegraph:$CIRCLE_TAG
      - docker tag us.gcr.io/sourcegraph-dev/sourcegraph:$CIRCLE_TAG sourcegraph/sourcegraph:latest
      - docker push sourcegraph/sourcegraph:$CIRCLE_TAG
      - docker push sourcegraph/sourcegraph:latest

      # deploy
      - curl http://deploy-bot.sourcegraph.com/set-branch-version -F "token=$DEPLOY_BOT_TOKEN" -F "branch=release" -F "version=$CIRCLE_TAG"
