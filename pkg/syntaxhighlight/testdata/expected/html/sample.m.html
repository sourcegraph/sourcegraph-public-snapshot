<span class="com">//</span><span class="">
</span><span class="com">//  OCTClient.m</span><span class="">
</span><span class="com">//  OctoKit</span><span class="">
</span><span class="com">//</span><span class="">
</span><span class="com">//  Created by Josh Abernathy on 3/6/12.</span><span class="">
</span><span class="com">//  Copyright (c) 2012 GitHub. All rights reserved.</span><span class="">
</span><span class="com">//</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTClient.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTClient+Private.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTClient+User.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;NSURL+OCTQueryAdditions.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTAccessToken.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTAuthorization.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTObject+Private.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTResponse.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTServer.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTServerMetadata.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;OCTUser.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="str">&#34;RACSignal+OCTClientAdditions.h&#34;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="pun">&lt;</span><span class="typ">ReactiveCocoa</span><span class="pun">/</span><span class="typ">ReactiveCocoa</span><span class="pun">.</span><span class="pln">h</span><span class="pun">&gt;</span><span class="">
</span><span class="pun">#</span><span class="kwd">import</span><span class=""> </span><span class="pun">&lt;</span><span class="typ">ReactiveCocoa</span><span class="pun">/</span><span class="typ">EXTScope</span><span class="pun">.</span><span class="pln">h</span><span class="pun">&gt;</span><span class="">
</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorDomain&#34;</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorAuthenticationFailed</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">666</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorServiceRequestFailed</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">667</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorConnectionFailed</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">668</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorJSONParsingFailed</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">669</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorBadRequest</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">670</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorTwoFactorAuthenticationOneTimePasswordRequired</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">671</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServer</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">672</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorOpeningBrowserFailed</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">673</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorRequestForbidden</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">674</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorTokenAuthenticationUnsupported</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">675</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServerScheme</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">676</span><span class="pun">;</span><span class="">
</span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientErrorSecureConnectionFailed</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">677</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorRequestURLKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorRequestURLKey&#34;</span><span class="pun">;</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorHTTPStatusCodeKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorHTTPStatusCodeKey&#34;</span><span class="pun">;</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorOneTimePasswordMediumKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorOneTimePasswordMediumKey&#34;</span><span class="pun">;</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorOAuthScopesStringKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorOAuthScopesStringKey&#34;</span><span class="pun">;</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorRequestStateRedirected</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorRequestRedirected&#34;</span><span class="pun">;</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorDescriptionKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorDescriptionKey&#34;</span><span class="pun">;</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientErrorMessagesKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;OCTClientErrorMessagesKey&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientAPIVersion</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;v3&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">/// See https://developer.github.com/changes/2014-12-08-removing-authorizations-token/</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientMiragePreviewAPIVersion</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;mirage-preview&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">/// See https://developer.github.com/changes/2014-12-08-organization-permissions-api-preview/</span><span class="">
</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientMoondragonPreviewAPIVersion</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;moondragon&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">OCTClientNotModifiedStatusCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">304</span><span class="pun">;</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientOneTimePasswordHeaderField</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;X-GitHub-OTP&#34;</span><span class="pun">;</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientOAuthScopesHeaderField</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;X-OAuth-Scopes&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// An environment variable that, when present, will enable logging of all</span><span class="">
</span><span class="com">// responses.</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientResponseLoggingEnvironmentKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;LOG_API_RESPONSES&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// An environment variable that, when present, will log the remaining API calls</span><span class="">
</span><span class="com">// allowed before the rate limit is enforced.</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="kwd">const</span><span class=""> </span><span class="typ">OCTClientRateLimitLoggingEnvironmentKey</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;LOG_REMAINING_API_CALLS&#34;</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="pun">@</span><span class="kwd">interface</span><span class=""> </span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">(</span><span class="pun">)</span><span class="">
</span><span class="pun">@</span><span class="kwd">property</span><span class=""> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class=""> </span><span class="pln">strong</span><span class="pun">,</span><span class=""> </span><span class="pln">readwrite</span><span class="pun">)</span><span class=""> </span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pln">user</span><span class="pun">;</span><span class="">
</span><span class="pun">@</span><span class="kwd">property</span><span class=""> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class=""> </span><span class="pln">copy</span><span class="pun">,</span><span class=""> </span><span class="pln">readwrite</span><span class="pun">)</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">token</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// Returns any user agent previously given to +setUserAgent:.</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">userAgent</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// Returns any OAuth client ID previously given to +setClientID:clientSecret:.</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">clientID</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// Returns any OAuth client secret previously given to</span><span class="">
</span><span class="com">// +setClientID:clientSecret:.</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">clientSecret</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// A subject to send callback URLs to after they&#39;re received by the app.</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSubject</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">callbackURLs</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="com">// Creates a request.</span><span class="">
</span><span class="com">//</span><span class="">
</span><span class="com">// method - The HTTP method to use in the request (e.g., &#34;GET&#34; or &#34;POST&#34;).</span><span class="">
</span><span class="com">// path   - The path to request, relative to the base API endpoint. This path</span><span class="">
</span><span class="com">//          should _not_ begin with a forward slash.</span><span class="">
</span><span class="com">// etag   - An ETag to compare the server data against, previously retrieved</span><span class="">
</span><span class="com">//          from an instance of OCTResponse.</span><span class="">
</span><span class="com">//</span><span class="">
</span><span class="com">// Returns a request which can be modified further before being enqueued.</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">method</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">path</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">parameters</span><span class=""> </span><span class="pln">notMatchingEtag</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">etag</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="pun">@</span><span class="kwd">end</span><span class="">
</span><span class="">
</span><span class="pun">@</span><span class="pln">implementation</span><span class=""> </span><span class="typ">OCTClient</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Properties</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">BOOL</span><span class="pun">)</span><span class="pln">isAuthenticated</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">token</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">setToken</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">token</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="pln">_token</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">token</span><span class=""> </span><span class="pln">copy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">token</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">clearAuthorizationHeader</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">setAuthorizationHeaderWithUsername</span><span class="pun">:</span><span class="pln">token</span><span class=""> </span><span class="pln">password</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;x-oauth-basic&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Class</span><span class=""> </span><span class="typ">Properties</span><span class="">
</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="typ">OCTClientUserAgent</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="typ">OCTClientOAuthClientID</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="kwd">static</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="typ">OCTClientOAuthClientSecret</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="pln">dispatch_queue_t</span><span class="pun">)</span><span class="pln">globalSettingsQueue</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">static</span><span class=""> </span><span class="pln">dispatch_queue_t</span><span class=""> </span><span class="pln">settingsQueue</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">static</span><span class=""> </span><span class="pln">dispatch_once_t</span><span class=""> </span><span class="pln">pred</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_once</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">pred</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">settingsQueue</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">dispatch_queue_create</span><span class="pun">(</span><span class="str">&#34;com.github.OctoKit.globalSettingsQueue&#34;</span><span class="pun">,</span><span class=""> </span><span class="typ">DISPATCH_QUEUE_CONCURRENT</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">settingsQueue</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">setUserAgent</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">userAgent</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">userAgent</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">copiedAgent</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">userAgent</span><span class=""> </span><span class="pln">copy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_barrier_async</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">globalSettingsQueue</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">OCTClientUserAgent</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">copiedAgent</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">userAgent</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="pln">__block</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">value</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_sync</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">globalSettingsQueue</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">value</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientUserAgent</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">value</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">setClientID</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">clientID</span><span class=""> </span><span class="pln">clientSecret</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">clientID</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">copiedID</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">clientID</span><span class=""> </span><span class="pln">copy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">copiedSecret</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">clientSecret</span><span class=""> </span><span class="pln">copy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_barrier_async</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">globalSettingsQueue</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">OCTClientOAuthClientID</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">copiedID</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">OCTClientOAuthClientSecret</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">copiedSecret</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">clientID</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="pln">__block</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">value</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_sync</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">globalSettingsQueue</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">value</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientOAuthClientID</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">value</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="pln">__block</span><span class=""> </span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">value</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_sync</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">globalSettingsQueue</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">value</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientOAuthClientSecret</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">value</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSubject</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">callbackURLs</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">static</span><span class=""> </span><span class="typ">RACSubject</span><span class=""> </span><span class="pun">*</span><span class="pln">singleton</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">static</span><span class=""> </span><span class="pln">dispatch_once_t</span><span class=""> </span><span class="pln">pred</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">dispatch_once</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">pred</span><span class="pun">,</span><span class=""> </span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">singleton</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="typ">RACSubject</span><span class=""> </span><span class="pln">subject</span><span class="pun">]</span><span class=""> </span><span class="pln">setNameWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;OCTClient.callbackURLs&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">singleton</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">userRequiredError</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Username Required&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedFailureReasonErrorKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;No username was provided for getting user information.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="typ">OCTClientErrorAuthenticationFailed</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">authenticationRequiredError</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Sign In Required&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedFailureReasonErrorKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;You must sign in to access user information.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="typ">OCTClientErrorAuthenticationFailed</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">unsupportedVersionError</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Unsupported Server&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedFailureReasonErrorKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;The request failed because the server is out of date.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="typ">OCTClientErrorUnsupportedServer</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">tokenUnsupportedError</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Password Required&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedFailureReasonErrorKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;You must sign in with a password. Token authentication is not supported.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="typ">OCTClientErrorTokenAuthenticationUnsupported</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Lifecycle</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="pln">id</span><span class="pun">)</span><span class="pln">initWithBaseURL</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">url</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="typ">NO</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;%@ must be initialized using -initWithServer:&#34;</span><span class="pun">,</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="pln">id</span><span class="pun">)</span><span class="pln">initWithServer</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">server</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">server</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">self</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">super</span><span class=""> </span><span class="pln">initWithBaseURL</span><span class="pun">:</span><span class="pln">server</span><span class="pun">.</span><span class="typ">APIEndpoint</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="kwd">self</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">userAgent</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">userAgent</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">userAgent</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">setDefaultHeader</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;User-Agent&#34;</span><span class=""> </span><span class="pln">value</span><span class="pun">:</span><span class="pln">userAgent</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pln">addAcceptableStatusCodes</span><span class="pun">:</span><span class="pun">[</span><span class="typ">NSIndexSet</span><span class=""> </span><span class="pln">indexSetWithIndex</span><span class="pun">:</span><span class="typ">OCTClientNotModifiedStatusCode</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">baseContentType</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;application/vnd.github.%@+json&#34;</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">stableContentType</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pln">baseContentType</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTClientAPIVersion</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">previewContentType</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pln">baseContentType</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTClientMiragePreviewAPIVersion</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">moondragonPreviewContentType</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pln">baseContentType</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTClientMoondragonPreviewAPIVersion</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">setDefaultHeader</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;Accept&#34;</span><span class=""> </span><span class="pln">value</span><span class="pun">:</span><span class="pln">moondragonPreviewContentType</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="typ">AFJSONRequestOperation</span><span class=""> </span><span class="pln">addAcceptableContentTypes</span><span class="pun">:</span><span class="pun">[</span><span class="typ">NSSet</span><span class=""> </span><span class="pln">setWithObjects</span><span class="pun">:</span><span class="pln">stableContentType</span><span class="pun">,</span><span class=""> </span><span class="pln">previewContentType</span><span class="pun">,</span><span class=""> </span><span class="pln">moondragonPreviewContentType</span><span class="pun">,</span><span class=""> </span><span class="kwd">nil</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">parameterEncoding</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">AFJSONParameterEncoding</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">registerHTTPOperationClass</span><span class="pun">:</span><span class="typ">AFJSONRequestOperation</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="kwd">self</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">unauthenticatedClientWithUser</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">user</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">user</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithServer</span><span class="pun">:</span><span class="pln">user</span><span class="pun">.</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pln">client</span><span class="pun">.</span><span class="pln">user</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">user</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">client</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">authenticatedClientWithUser</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">user</span><span class=""> </span><span class="pln">token</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">token</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">user</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">token</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithServer</span><span class="pun">:</span><span class="pln">user</span><span class="pun">.</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pln">client</span><span class="pun">.</span><span class="pln">user</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">user</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pln">client</span><span class="pun">.</span><span class="pln">token</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">token</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">client</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Authentication</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSArray</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">scopesArrayFromScopes</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopes</span><span class="pun">)</span><span class="pln">scopes</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">scopeToScopeString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesPublicReadOnly</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesUserEmail</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;user:email&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesUserFollow</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;user:follow&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesUser</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;user&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesRepositoryStatus</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;repo:status&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesPublicRepository</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;public_repo&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesRepository</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;repo&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesRepositoryDelete</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;delete_repo&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesNotifications</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;notifications&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesGist</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;gist&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesPublicKeyRead</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;read:public_key&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesPublicKeyWrite</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;write:public_key&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopesPublicKeyAdmin</span><span class="pun">)</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;admin:public_key&#34;</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pln">scopeToScopeString</span><span class="pun">.</span><span class="pln">rac_keySequence</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">filter</span><span class="pun">:</span><span class="pun">^</span><span class=""> </span><span class="typ">BOOL</span><span class=""> </span><span class="pun">(</span><span class="typ">NSNumber</span><span class=""> </span><span class="pun">*</span><span class="pln">scopeValue</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTClientAuthorizationScopes</span><span class=""> </span><span class="pln">scope</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">scopeValue</span><span class="pun">.</span><span class="pln">unsignedIntegerValue</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">(</span><span class="pln">scopes</span><span class=""> </span><span class="pun">&amp;</span><span class=""> </span><span class="pln">scope</span><span class="pun">)</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="dec">0</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">map</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSNumber</span><span class=""> </span><span class="pun">*</span><span class="pln">scopeValue</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">scopeToScopeString</span><span class="pun">[</span><span class="pln">scopeValue</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">filter</span><span class="pun">:</span><span class="pun">^</span><span class=""> </span><span class="typ">BOOL</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">scopeString</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">scopeString</span><span class="pun">.</span><span class="pln">length</span><span class=""> </span><span class="pun">&gt;</span><span class=""> </span><span class="dec">0</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">array</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">signInAsUser</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">user</span><span class=""> </span><span class="pln">password</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">password</span><span class=""> </span><span class="pln">oneTimePassword</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">oneTimePassword</span><span class=""> </span><span class="pln">scopes</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopes</span><span class="pun">)</span><span class="pln">scopes</span><span class=""> </span><span class="pln">note</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">note</span><span class=""> </span><span class="pln">noteURL</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">noteURL</span><span class=""> </span><span class="pln">fingerprint</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">fingerprint</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">user</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">password</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">clientID</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">clientID</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">clientSecret</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">clientID</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class=""> </span><span class="pun">&amp;</span><span class="pun">&amp;</span><span class=""> </span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;+setClientID:clientSecret: must be invoked before calling %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="typ">NSStringFromSelector</span><span class="pun">(</span><span class="pln">_cmd</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="pun">(</span><span class="pun">^</span><span class="pln">authorizationSignalWithUser</span><span class="pun">)</span><span class="pun">(</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pln">user</span><span class="pun">)</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pln">user</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">defer</span><span class="pun">:</span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">unauthenticatedClientWithUser</span><span class="pun">:</span><span class="pln">user</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">client</span><span class=""> </span><span class="pln">setAuthorizationHeaderWithUsername</span><span class="pun">:</span><span class="pln">user</span><span class="pun">.</span><span class="pln">rawLogin</span><span class=""> </span><span class="pln">password</span><span class="pun">:</span><span class="pln">password</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">path</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;authorizations/clients/%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">clientID</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">params</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;scopes&#34;</span><span class="pun">:</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">scopesArrayFromScopes</span><span class="pun">:</span><span class="pln">scopes</span><span class="pun">]</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;client_secret&#34;</span><span class="pun">:</span><span class=""> </span><span class="pln">clientSecret</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="pln">mutableCopy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">note</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">params</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;note&#34;</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">note</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">noteURL</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">params</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;note_url&#34;</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">noteURL</span><span class="pun">.</span><span class="pln">absoluteString</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">fingerprint</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">params</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;fingerprint&#34;</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">fingerprint</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">request</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">client</span><span class=""> </span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;PUT&#34;</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pln">path</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pln">params</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">request</span><span class="pun">.</span><span class="pln">cachePolicy</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSURLRequestReloadIgnoringLocalCacheData</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">oneTimePassword</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">setValue</span><span class="pun">:</span><span class="pln">oneTimePassword</span><span class=""> </span><span class="pln">forHTTPHeaderField</span><span class="pun">:</span><span class="typ">OCTClientOneTimePasswordHeaderField</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">previewContentType</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;application/vnd.github.%@+json&#34;</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTClientMiragePreviewAPIVersion</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">setValue</span><span class="pun">:</span><span class="pln">previewContentType</span><span class=""> </span><span class="pln">forHTTPHeaderField</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;Accept&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pln">tokenSignal</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">client</span><span class=""> </span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="typ">OCTAuthorization</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">combineLatest</span><span class="pun">:</span><span class="pun">@</span><span class="pun">[</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">client</span><span class="pun">]</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">tokenSignal</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pln">authorizationSignalWithUser</span><span class="pun">(</span><span class="pln">user</span><span class="pun">)</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">flattenMap</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">RACTuple</span><span class=""> </span><span class="pun">*</span><span class="pln">clientAndResponse</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">RACTupleUnpack</span><span class="pun">(</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTResponse</span><span class=""> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">)</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">clientAndResponse</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTAuthorization</span><span class=""> </span><span class="pun">*</span><span class="pln">authorization</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">response</span><span class="pun">.</span><span class="pln">parsedResult</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// To increase security, tokens are no longer returned when the authorization</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// already exists. If that happens, we need to delete the existing</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// authorization for this app and create a new one, so we end up with a token</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// of our own.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">//</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// The `fingerprint` field provided will be used to ensure uniqueness and</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// avoid deleting unrelated tokens.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">authorization</span><span class="pun">.</span><span class="pln">token</span><span class="pun">.</span><span class="pln">length</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">0</span><span class=""> </span><span class="pun">&amp;</span><span class="pun">&amp;</span><span class=""> </span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusCode</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">200</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">path</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;authorizations/%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">authorization</span><span class="pun">.</span><span class="pln">objectID</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">request</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">client</span><span class=""> </span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;DELETE&#34;</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pln">path</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">request</span><span class="pun">.</span><span class="pln">cachePolicy</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSURLRequestReloadIgnoringLocalCacheData</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">oneTimePassword</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">setValue</span><span class="pun">:</span><span class="pln">oneTimePassword</span><span class=""> </span><span class="pln">forHTTPHeaderField</span><span class="pun">:</span><span class="typ">OCTClientOneTimePasswordHeaderField</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pln">client</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">then</span><span class="pun">:</span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// Try logging in again.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">authorizationSignalWithUser</span><span class="pun">(</span><span class="pln">user</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">clientAndResponse</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">catch</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">code</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServerScheme</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pln">secureServer</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="typ">HTTPSEnterpriseServerWithServer</span><span class="pun">:</span><span class="pln">user</span><span class="pun">.</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pln">secureUser</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">OCTUser</span><span class=""> </span><span class="pln">userWithRawLogin</span><span class="pun">:</span><span class="pln">user</span><span class="pun">.</span><span class="pln">rawLogin</span><span class=""> </span><span class="pln">server</span><span class="pun">:</span><span class="pln">secureServer</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">authorizationSignalWithUser</span><span class="pun">(</span><span class="pln">secureUser</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSNumber</span><span class=""> </span><span class="pun">*</span><span class="pln">statusCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">error</span><span class="pun">.</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorHTTPStatusCodeKey</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">statusCode</span><span class="pun">.</span><span class="pln">integerValue</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">404</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorOAuthScopesStringKey</span><span class="pun">]</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">error</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">tokenUnsupportedError</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">error</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">unsupportedVersionError</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">reduceEach</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTResponse</span><span class=""> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTAuthorization</span><span class=""> </span><span class="pun">*</span><span class="pln">authorization</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">response</span><span class="pun">.</span><span class="pln">parsedResult</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">client</span><span class="pun">.</span><span class="pln">token</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">authorization</span><span class="pun">.</span><span class="pln">token</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">client</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">replayLazily</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">setNameWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;+signInAsUser: %@ password:oneTimePassword:scopes:&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">user</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">signInToServerUsingWebBrowser</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">server</span><span class=""> </span><span class="pln">scopes</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopes</span><span class="pun">)</span><span class="pln">scopes</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">server</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">clientID</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">clientID</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">clientSecret</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">clientID</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class=""> </span><span class="pun">&amp;</span><span class="pun">&amp;</span><span class=""> </span><span class="pln">clientSecret</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;+setClientID:clientSecret: must be invoked before calling %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="typ">NSStringFromSelector</span><span class="pun">(</span><span class="pln">_cmd</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">authorizeWithServerUsingWebBrowser</span><span class="pun">:</span><span class="pln">server</span><span class=""> </span><span class="pln">scopes</span><span class="pun">:</span><span class="pln">scopes</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">combineLatestWith</span><span class="pun">:</span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">catch</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">code</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServerScheme</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pln">secureServer</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="typ">HTTPSEnterpriseServerWithServer</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">authorizeWithServerUsingWebBrowser</span><span class="pun">:</span><span class="pln">secureServer</span><span class=""> </span><span class="pln">scopes</span><span class="pun">:</span><span class="pln">scopes</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">combineLatestWith</span><span class="pun">:</span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">reduceEach</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">temporaryCode</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pln">server</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">params</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;client_id&#34;</span><span class="pun">:</span><span class=""> </span><span class="pln">clientID</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;client_secret&#34;</span><span class="pun">:</span><span class=""> </span><span class="pln">clientSecret</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;code&#34;</span><span class="pun">:</span><span class=""> </span><span class="pln">temporaryCode</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">(</span><span class="pun">^</span><span class="pln">clientAndTokenSignalWithServer</span><span class="pun">)</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pln">server</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithServer</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// We&#39;re using -requestWithMethod: for its parameter encoding and</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// User-Agent behavior, but we&#39;ll replace the key properties so we</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// can POST to another host.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">request</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">client</span><span class=""> </span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;POST&#34;</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pln">params</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">request</span><span class="pun">.</span><span class="pln">cachePolicy</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSURLRequestReloadIgnoringLocalCacheData</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">request</span><span class="pun">.</span><span class="typ">URL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSURL</span><span class=""> </span><span class="typ">URLWithString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;login/oauth/access_token&#34;</span><span class=""> </span><span class="pln">relativeToURL</span><span class="pun">:</span><span class="pln">server</span><span class="pun">.</span><span class="pln">baseWebURL</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// The `Accept` string we normally use (where we specify the beta</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// version of the API) doesn&#39;t work for this endpoint. Just plain</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// JSON.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">setValue</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;application/json&#34;</span><span class=""> </span><span class="pln">forHTTPHeaderField</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;Accept&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pln">tokenSignal</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pln">client</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="typ">OCTAccessToken</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">oct_parsedResults</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">combineLatest</span><span class="pun">:</span><span class="pun">@</span><span class="pun">[</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">client</span><span class="pun">]</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">tokenSignal</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pln">clientAndTokenSignalWithServer</span><span class="pun">(</span><span class="pln">server</span><span class="pun">)</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">catch</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">code</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServerScheme</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pln">secureServer</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="typ">HTTPSEnterpriseServerWithServer</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">clientAndTokenSignalWithServer</span><span class="pun">(</span><span class="pln">secureServer</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">flatten</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">reduceEach</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class="pun">,</span><span class=""> </span><span class="typ">OCTAccessToken</span><span class=""> </span><span class="pun">*</span><span class="pln">accessToken</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">client</span><span class="pun">.</span><span class="pln">token</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">accessToken</span><span class="pun">.</span><span class="pln">token</span><span class=""> </span><span class="pln">copy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">client</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">flattenMap</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pln">client</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">fetchUserInfo</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">doNext</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pln">user</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userDict</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">user</span><span class="pun">.</span><span class="pln">dictionaryValue</span><span class=""> </span><span class="pln">mutableCopy</span><span class="pun">]</span><span class=""> </span><span class="pun">?</span><span class="pun">:</span><span class=""> </span><span class="pun">[</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pln">dictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">user</span><span class="pun">.</span><span class="pln">rawLogin</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">userDict</span><span class="pun">[</span><span class="pun">@</span><span class="pln">keypath</span><span class="pun">(</span><span class="pln">user</span><span class="pun">.</span><span class="pln">rawLogin</span><span class="pun">)</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">user</span><span class="pun">.</span><span class="pln">login</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTUser</span><span class=""> </span><span class="pun">*</span><span class="pln">userWithRawLogin</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">OCTUser</span><span class=""> </span><span class="pln">modelWithDictionary</span><span class="pun">:</span><span class="pln">userDict</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="typ">NULL</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">client</span><span class="pun">.</span><span class="pln">user</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">userWithRawLogin</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">mapReplace</span><span class="pun">:</span><span class="pln">client</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">replayLazily</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">setNameWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;+signInToServerUsingWebBrowser: %@ scopes:&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">authorizeWithServerUsingWebBrowser</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">server</span><span class=""> </span><span class="pln">scopes</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTClientAuthorizationScopes</span><span class="pun">)</span><span class="pln">scopes</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">server</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">clientID</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">clientID</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">clientID</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;+setClientID:clientSecret: must be invoked before calling %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="typ">NSStringFromSelector</span><span class="pun">(</span><span class="pln">_cmd</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">createSignal</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="pln">id</span><span class="pun">&lt;</span><span class="typ">RACSubscriber</span><span class="pun">&gt;</span><span class=""> </span><span class="pln">subscriber</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">CFUUIDRef</span><span class=""> </span><span class="pln">uuid</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">CFUUIDCreate</span><span class="pun">(</span><span class="typ">NULL</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">uuidString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">CFBridgingRelease</span><span class="pun">(</span><span class="typ">CFUUIDCreateString</span><span class="pun">(</span><span class="typ">NULL</span><span class="pun">,</span><span class=""> </span><span class="pln">uuid</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">CFRelease</span><span class="pun">(</span><span class="pln">uuid</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// For any matching callback URL, send the temporary code to our</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// subscriber.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">//</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// This should be set up before opening the URL below, or we may</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// miss values on self.callbackURLs.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">RACDisposable</span><span class=""> </span><span class="pun">*</span><span class="pln">callbackDisposable</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">callbackURLs</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">flattenMap</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="typ">URL</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">queryArguments</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">URL</span><span class="pun">.</span><span class="pln">oct_queryArguments</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">queryArguments</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;state&#34;</span><span class="pun">]</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pln">uuidString</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">queryArguments</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;code&#34;</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">empty</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">take</span><span class="pun">:</span><span class="dec">1</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">subscribe</span><span class="pun">:</span><span class="pln">subscriber</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">scope</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">scopesArrayFromScopes</span><span class="pun">:</span><span class="pln">scopes</span><span class="pun">]</span><span class=""> </span><span class="pln">componentsJoinedByString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;,&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// Trim trailing slashes from URL entered by the user, so we don&#39;t open</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// their web browser to a URL that contains empty path components.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSCharacterSet</span><span class=""> </span><span class="pun">*</span><span class="pln">slashSet</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSCharacterSet</span><span class=""> </span><span class="pln">characterSetWithCharactersInString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;/&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">baseURLString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">server</span><span class="pun">.</span><span class="pln">baseWebURL</span><span class="pun">.</span><span class="pln">absoluteString</span><span class=""> </span><span class="pln">stringByTrimmingCharactersInSet</span><span class="pun">:</span><span class="pln">slashSet</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="typ">URLString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;%@/login/oauth/authorize?client_id=%@&amp;scope=%@&amp;state=%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">baseURLString</span><span class="pun">,</span><span class=""> </span><span class="pln">clientID</span><span class="pun">,</span><span class=""> </span><span class="pln">scope</span><span class="pun">,</span><span class=""> </span><span class="pln">uuidString</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pln">webURL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSURL</span><span class=""> </span><span class="typ">URLWithString</span><span class="pun">:</span><span class="typ">URLString</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">!</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">openURL</span><span class="pun">:</span><span class="pln">webURL</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendError</span><span class="pun">:</span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="typ">OCTClientErrorOpeningBrowserFailed</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Could not open web browser&#34;</span><span class="pun">,</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSLocalizedRecoverySuggestionErrorKey</span><span class="pun">:</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Please make sure you have a default web browser set.&#34;</span><span class="pun">,</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSURLErrorKey</span><span class="pun">:</span><span class=""> </span><span class="pln">webURL</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">callbackDisposable</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class=""> </span><span class="pln">setNameWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;+authorizeWithServerUsingWebBrowser: %@ scopes:&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">fetchMetadataForServer</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">server</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">server</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">OCTClient</span><span class=""> </span><span class="pun">*</span><span class="pln">client</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithServer</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">request</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">client</span><span class=""> </span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;GET&#34;</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;meta&#34;</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="kwd">nil</span><span class=""> </span><span class="pln">notMatchingEtag</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pln">client</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="typ">OCTServerMetadata</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">catch</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">code</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServerScheme</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pln">secureServer</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="typ">HTTPSEnterpriseServerWithServer</span><span class="pun">:</span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">fetchMetadataForServer</span><span class="pun">:</span><span class="pln">secureServer</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSNumber</span><span class=""> </span><span class="pun">*</span><span class="pln">statusCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">error</span><span class="pun">.</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorHTTPStatusCodeKey</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">statusCode</span><span class="pun">.</span><span class="pln">integerValue</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">404</span><span class="pun">)</span><span class=""> </span><span class="pln">error</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">unsupportedVersionError</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">oct_parsedResults</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">setNameWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;+fetchMetadataForServer: %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">server</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="typ">HTTPSEnterpriseServerWithServer</span><span class="pun">:</span><span class="pun">(</span><span class="typ">OCTServer</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">server</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="typ">URL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">server</span><span class="pun">.</span><span class="pln">baseURL</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">path</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">(</span><span class="typ">URL</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">length</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">0</span><span class=""> </span><span class="pun">?</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;/&#34;</span><span class=""> </span><span class="pun">:</span><span class=""> </span><span class="typ">URL</span><span class="pun">.</span><span class="pln">path</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pln">secureURL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="typ">NSURL</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithScheme</span><span class="pun">:</span><span class="typ">OCTServerHTTPSEnterpriseScheme</span><span class=""> </span><span class="pln">host</span><span class="pun">:</span><span class="typ">URL</span><span class="pun">.</span><span class="pln">host</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pln">path</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">OCTServer</span><span class=""> </span><span class="pln">serverWithBaseURL</span><span class="pun">:</span><span class="pln">secureURL</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">BOOL</span><span class="pun">)</span><span class="pln">openURL</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="typ">URL</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="typ">URL</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pun">#</span><span class="pln">ifdef</span><span class=""> </span><span class="pln">__IPHONE_OS_VERSION_MIN_REQUIRED</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="typ">UIApplication</span><span class="pun">.</span><span class="pln">sharedApplication</span><span class=""> </span><span class="pln">canOpenURL</span><span class="pun">:</span><span class="typ">URL</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="typ">UIApplication</span><span class="pun">.</span><span class="pln">sharedApplication</span><span class=""> </span><span class="pln">openURL</span><span class="pun">:</span><span class="typ">URL</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="typ">YES</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="typ">NO</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="pun">#</span><span class="kwd">else</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSWorkspace</span><span class="pun">.</span><span class="pln">sharedWorkspace</span><span class=""> </span><span class="pln">openURL</span><span class="pun">:</span><span class="typ">URL</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">#</span><span class="pln">endif</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">completeSignInWithCallbackURL</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">callbackURL</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">callbackURL</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">callbackURLs</span><span class=""> </span><span class="pln">sendNext</span><span class="pun">:</span><span class="pln">callbackURL</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Request</span><span class=""> </span><span class="typ">Creation</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">method</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">path</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">parameters</span><span class=""> </span><span class="pln">notMatchingEtag</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">etag</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">method</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">method</span><span class=""> </span><span class="pln">isEqualToString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;GET&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">!</span><span class="pun">[</span><span class="pln">parameters</span><span class="pun">.</span><span class="pln">allKeys</span><span class=""> </span><span class="pln">containsObject</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;per_page&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">parameters</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">parameters</span><span class=""> </span><span class="pun">?</span><span class="pun">:</span><span class=""> </span><span class="pun">[</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pln">dictionary</span><span class="pun">]</span><span class=""> </span><span class="pln">mtl_dictionaryByAddingEntriesFromDictionary</span><span class="pun">:</span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;per_page&#34;</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="dec">100</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">request</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pln">method</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pun">[</span><span class="pln">path</span><span class=""> </span><span class="pln">stringByAddingPercentEscapesUsingEncoding</span><span class="pun">:</span><span class="typ">NSUTF8StringEncoding</span><span class="pun">]</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pln">parameters</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">etag</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">setValue</span><span class="pun">:</span><span class="pln">etag</span><span class=""> </span><span class="pln">forHTTPHeaderField</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;If-None-Match&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// If an etag is specified, we want 304 responses to be treated as 304s,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="com">// not served from NSURLCache with a status of 200.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">request</span><span class="pun">.</span><span class="pln">cachePolicy</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSURLRequestReloadIgnoringLocalCacheData</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">request</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Request</span><span class=""> </span><span class="typ">Enqueuing</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">request</span><span class=""> </span><span class="pln">fetchAllPages</span><span class="pun">:</span><span class="pun">(</span><span class="typ">BOOL</span><span class="pun">)</span><span class="pln">fetchAllPages</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">originalRequest</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">copy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pln">signal</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">createSignal</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="pln">id</span><span class="pun">&lt;</span><span class="typ">RACSubscriber</span><span class="pun">&gt;</span><span class=""> </span><span class="pln">subscriber</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pln">operation</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="typ">HTTPRequestOperationWithRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">success</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pln">operation</span><span class="pun">,</span><span class=""> </span><span class="pln">id</span><span class=""> </span><span class="pln">responseObject</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="typ">NSProcessInfo</span><span class="pun">.</span><span class="pln">processInfo</span><span class="pun">.</span><span class="pln">environment</span><span class="pun">[</span><span class="typ">OCTClientResponseLoggingEnvironmentKey</span><span class="pun">]</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSLog</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ %@ =&gt; %li %@:\n%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="typ">HTTPMethod</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="pln">allHTTPHeaderFields</span><span class="pun">,</span><span class=""> </span><span class="pun">(</span><span class="kwd">long</span><span class="pun">)</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusCode</span><span class="pun">,</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">allHeaderFields</span><span class="pun">,</span><span class=""> </span><span class="pln">responseObject</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusCode</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientNotModifiedStatusCode</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// No change in the data.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendCompleted</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pln">nextPageSignal</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">empty</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pln">nextPageURL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">(</span><span class="pln">fetchAllPages</span><span class=""> </span><span class="pun">?</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">nextPageURLFromOperation</span><span class="pun">:</span><span class="pln">operation</span><span class="pun">]</span><span class=""> </span><span class="pun">:</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">nextPageURL</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// If we got this far, the etag is out of date, so don&#39;t pass it on.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">nextRequest</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">request</span><span class=""> </span><span class="pln">mutableCopy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">nextRequest</span><span class="pun">.</span><span class="typ">URL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">nextPageURL</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">nextPageSignal</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">nextRequest</span><span class=""> </span><span class="pln">fetchAllPages</span><span class="pun">:</span><span class="typ">YES</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="typ">RACSignal</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class="pun">:</span><span class="typ">RACTuplePack</span><span class="pun">(</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">,</span><span class=""> </span><span class="pln">responseObject</span><span class="pun">)</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">concat</span><span class="pun">:</span><span class="pln">nextPageSignal</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">subscribe</span><span class="pun">:</span><span class="pln">subscriber</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="pln">failure</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pln">operation</span><span class="pun">,</span><span class=""> </span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="typ">NSProcessInfo</span><span class="pun">.</span><span class="pln">processInfo</span><span class="pun">.</span><span class="pln">environment</span><span class="pun">[</span><span class="typ">OCTClientResponseLoggingEnvironmentKey</span><span class="pun">]</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSLog</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ %@ =&gt; FAILED WITH %li&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="typ">HTTPMethod</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="pln">allHTTPHeaderFields</span><span class="pun">,</span><span class=""> </span><span class="pun">(</span><span class="kwd">long</span><span class="pun">)</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusCode</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendError</span><span class="pun">:</span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class=""> </span><span class="pln">errorFromRequestOperation</span><span class="pun">:</span><span class="pln">operation</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">successCallbackQueue</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">dispatch_get_global_queue</span><span class="pun">(</span><span class="typ">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="pun">,</span><span class=""> </span><span class="dec">0</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">failureCallbackQueue</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">dispatch_get_global_queue</span><span class="pun">(</span><span class="typ">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="pun">,</span><span class=""> </span><span class="dec">0</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pln">weakify</span><span class="pun">(</span><span class="pln">operation</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">redirectResponseBlock</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSURLConnection</span><span class=""> </span><span class="pun">*</span><span class="pln">connection</span><span class="pun">,</span><span class=""> </span><span class="typ">NSURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">currentRequest</span><span class="pun">,</span><span class=""> </span><span class="typ">NSURLResponse</span><span class=""> </span><span class="pun">*</span><span class="pln">redirectResponse</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="pln">strongify</span><span class="pun">(</span><span class="pln">operation</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">redirectResponse</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class=""> </span><span class="pln">currentRequest</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// Append OCTClientErrorRequestStateRedirected to the current</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// operation&#39;s userInfo when redirecting to a different URL scheme</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">currentHost</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">currentRequest</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="pln">host</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">originalHost</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">originalRequest</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="pln">host</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">currentScheme</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">currentRequest</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="pln">scheme</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">originalScheme</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">originalRequest</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="pln">scheme</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">BOOL</span><span class=""> </span><span class="pln">hasOriginalHost</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">currentHost</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pln">originalHost</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">BOOL</span><span class=""> </span><span class="pln">hasOriginalScheme</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">currentScheme</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pln">originalScheme</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">hasOriginalHost</span><span class=""> </span><span class="pun">&amp;</span><span class="pun">&amp;</span><span class=""> </span><span class="pun">!</span><span class="pln">hasOriginalScheme</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTClientErrorRequestStateRedirected</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="typ">YES</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">currentRequest</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">enqueueHTTPRequestOperation</span><span class="pun">:</span><span class="pln">operation</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACDisposable</span><span class=""> </span><span class="pln">disposableWithBlock</span><span class="pun">:</span><span class="pun">^</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">operation</span><span class=""> </span><span class="pln">cancel</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pln">signal</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">replayLazily</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">setNameWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;-enqueueRequest: %@ fetchAllPages: %i&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">request</span><span class="pun">,</span><span class=""> </span><span class="pun">(</span><span class="kwd">int</span><span class="pun">)</span><span class="pln">fetchAllPages</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">)</span><span class="pln">resultClass</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="pln">resultClass</span><span class=""> </span><span class="pln">fetchAllPages</span><span class="pun">:</span><span class="typ">YES</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">)</span><span class="pln">resultClass</span><span class=""> </span><span class="pln">fetchAllPages</span><span class="pun">:</span><span class="pun">(</span><span class="typ">BOOL</span><span class="pun">)</span><span class="pln">fetchAllPages</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">fetchAllPages</span><span class="pun">:</span><span class="pln">fetchAllPages</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">reduceEach</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSHTTPURLResponse</span><span class=""> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">,</span><span class=""> </span><span class="pln">id</span><span class=""> </span><span class="pln">responseObject</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">__block</span><span class=""> </span><span class="typ">BOOL</span><span class=""> </span><span class="pln">loggedRemaining</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NO</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="kwd">self</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">parsedResponseOfClass</span><span class="pun">:</span><span class="pln">resultClass</span><span class=""> </span><span class="pln">fromJSON</span><span class="pun">:</span><span class="pln">responseObject</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">map</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="pln">id</span><span class=""> </span><span class="pln">parsedResult</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTResponse</span><span class=""> </span><span class="pun">*</span><span class="pln">parsedResponse</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="typ">OCTResponse</span><span class=""> </span><span class="pln">alloc</span><span class="pun">]</span><span class=""> </span><span class="pln">initWithHTTPURLResponse</span><span class="pun">:</span><span class="pln">response</span><span class=""> </span><span class="pln">parsedResult</span><span class="pun">:</span><span class="pln">parsedResult</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">parsedResponse</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;Could not create OCTResponse with response %@ and parsedResult %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">response</span><span class="pun">,</span><span class=""> </span><span class="pln">parsedResult</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">parsedResponse</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">doNext</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">OCTResponse</span><span class=""> </span><span class="pun">*</span><span class="pln">parsedResponse</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="typ">NSProcessInfo</span><span class="pun">.</span><span class="pln">processInfo</span><span class="pun">.</span><span class="pln">environment</span><span class="pun">[</span><span class="typ">OCTClientRateLimitLoggingEnvironmentKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">loggedRemaining</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSLog</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ =&gt; %li remaining calls: %li/%li&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">response</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span><span class=""> </span><span class="pun">(</span><span class="kwd">long</span><span class="pun">)</span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusCode</span><span class="pun">,</span><span class=""> </span><span class="pun">(</span><span class="kwd">long</span><span class="pun">)</span><span class="pln">parsedResponse</span><span class="pun">.</span><span class="pln">remainingRequests</span><span class="pun">,</span><span class=""> </span><span class="pun">(</span><span class="kwd">long</span><span class="pun">)</span><span class="pln">parsedResponse</span><span class="pun">.</span><span class="pln">maximumRequestsPerHour</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">loggedRemaining</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">YES</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">concat</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">enqueueUserRequestWithMethod</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">method</span><span class=""> </span><span class="pln">relativePath</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">relativePath</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">parameters</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">)</span><span class="pln">resultClass</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">method</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pun">[</span><span class="pln">relativePath</span><span class=""> </span><span class="pln">isEqualToString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">]</span><span class=""> </span><span class="pun">|</span><span class="pun">|</span><span class=""> </span><span class="pun">[</span><span class="pln">relativePath</span><span class=""> </span><span class="pln">hasPrefix</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;/&#34;</span><span class="pun">]</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;%@ is not a valid relativePath, it must start with @\&#34;/\&#34;, or equal @\&#34;\&#34;&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">relativePath</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">path</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">authenticated</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">path</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;user%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">relativePath</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">user</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">path</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;users/%@%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">user</span><span class="pun">.</span><span class="pln">login</span><span class="pun">,</span><span class=""> </span><span class="pln">relativePath</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">userRequiredError</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSMutableURLRequest</span><span class=""> </span><span class="pun">*</span><span class="pln">request</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">requestWithMethod</span><span class="pun">:</span><span class="pln">method</span><span class=""> </span><span class="pln">path</span><span class="pun">:</span><span class="pln">path</span><span class=""> </span><span class="pln">parameters</span><span class="pun">:</span><span class="pln">parameters</span><span class=""> </span><span class="pln">notMatchingEtag</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">authenticated</span><span class="pun">)</span><span class=""> </span><span class="pln">request</span><span class="pun">.</span><span class="pln">cachePolicy</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSURLRequestReloadIgnoringLocalCacheData</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">enqueueRequest</span><span class="pun">:</span><span class="pln">request</span><span class=""> </span><span class="pln">resultClass</span><span class="pun">:</span><span class="pln">resultClass</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Pagination</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSURL</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">nextPageURLFromOperation</span><span class="pun">:</span><span class="pun">(</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">operation</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">header</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">allHeaderFields</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">linksString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">header</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;Link&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">linksString</span><span class="pun">.</span><span class="pln">length</span><span class=""> </span><span class="pun">&lt;</span><span class=""> </span><span class="dec">1</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSRegularExpression</span><span class=""> </span><span class="pun">*</span><span class="pln">relPattern</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSRegularExpression</span><span class=""> </span><span class="pln">regularExpressionWithPattern</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;rel=\\\&#34;?([^\\\&#34;]+)\\\&#34;?&#34;</span><span class=""> </span><span class="pln">options</span><span class="pun">:</span><span class="typ">NSRegularExpressionCaseInsensitive</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="pun">&amp;</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">relPattern</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;Error constructing regular expression pattern: %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">error</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSMutableCharacterSet</span><span class=""> </span><span class="pun">*</span><span class="pln">whitespaceAndBracketCharacterSet</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSCharacterSet</span><span class="pun">.</span><span class="pln">whitespaceCharacterSet</span><span class=""> </span><span class="pln">mutableCopy</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="pln">whitespaceAndBracketCharacterSet</span><span class=""> </span><span class="pln">addCharactersInString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;&lt;&gt;&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSArray</span><span class=""> </span><span class="pun">*</span><span class="pln">links</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">linksString</span><span class=""> </span><span class="pln">componentsSeparatedByString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;,&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">for</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">link</span><span class=""> </span><span class="kwd">in</span><span class=""> </span><span class="pln">links</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSRange</span><span class=""> </span><span class="pln">semicolonRange</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">link</span><span class=""> </span><span class="pln">rangeOfString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;;&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">semicolonRange</span><span class="pun">.</span><span class="pln">location</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="typ">NSNotFound</span><span class="pun">)</span><span class=""> </span><span class="kwd">continue</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="typ">URLString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pln">link</span><span class=""> </span><span class="pln">substringToIndex</span><span class="pun">:</span><span class="pln">semicolonRange</span><span class="pun">.</span><span class="pln">location</span><span class="pun">]</span><span class=""> </span><span class="pln">stringByTrimmingCharactersInSet</span><span class="pun">:</span><span class="pln">whitespaceAndBracketCharacterSet</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="typ">URLString</span><span class="pun">.</span><span class="pln">length</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">0</span><span class="pun">)</span><span class=""> </span><span class="kwd">continue</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSTextCheckingResult</span><span class=""> </span><span class="pun">*</span><span class="pln">result</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">relPattern</span><span class=""> </span><span class="pln">firstMatchInString</span><span class="pun">:</span><span class="pln">link</span><span class=""> </span><span class="pln">options</span><span class="pun">:</span><span class="dec">0</span><span class=""> </span><span class="pln">range</span><span class="pun">:</span><span class="typ">NSMakeRange</span><span class="pun">(</span><span class="dec">0</span><span class="pun">,</span><span class=""> </span><span class="pln">link</span><span class="pun">.</span><span class="pln">length</span><span class="pun">)</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">result</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="kwd">continue</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="kwd">type</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">link</span><span class=""> </span><span class="pln">substringWithRange</span><span class="pun">:</span><span class="pun">[</span><span class="pln">result</span><span class=""> </span><span class="pln">rangeAtIndex</span><span class="pun">:</span><span class="dec">1</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">!</span><span class="pun">[</span><span class="kwd">type</span><span class=""> </span><span class="pln">isEqualToString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;next&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="kwd">continue</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSURL</span><span class=""> </span><span class="typ">URLWithString</span><span class="pun">:</span><span class="typ">URLString</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">perPageWithPerPage</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">perPage</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">perPage</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="dec">0</span><span class=""> </span><span class="pun">|</span><span class="pun">|</span><span class=""> </span><span class="pln">perPage</span><span class=""> </span><span class="pun">&gt;</span><span class=""> </span><span class="dec">100</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">perPage</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="dec">30</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">perPage</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">pageWithOffset</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">offset</span><span class=""> </span><span class="pln">perPage</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">perPage</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">offset</span><span class=""> </span><span class="pun">/</span><span class=""> </span><span class="pln">perPage</span><span class=""> </span><span class="pun">+</span><span class=""> </span><span class="dec">1</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">pageOffsetWithOffset</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">offset</span><span class=""> </span><span class="pln">perPage</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSUInteger</span><span class="pun">)</span><span class="pln">perPage</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">offset</span><span class=""> </span><span class="pun">%</span><span class=""> </span><span class="pln">perPage</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Parsing</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">parsingErrorWithFailureReason</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">localizedFailureReason</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pln">dictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Could not parse the service response.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">localizedFailureReason</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">NSLocalizedFailureReasonErrorKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">localizedFailureReason</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="typ">OCTClientErrorJSONParsingFailed</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">-</span><span class=""> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">parsedResponseOfClass</span><span class="pun">:</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">)</span><span class="pln">resultClass</span><span class=""> </span><span class="pln">fromJSON</span><span class="pun">:</span><span class="pun">(</span><span class="pln">id</span><span class="pun">)</span><span class="pln">responseObject</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">resultClass</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class=""> </span><span class="pun">|</span><span class="pun">|</span><span class=""> </span><span class="pun">[</span><span class="pln">resultClass</span><span class=""> </span><span class="pln">isSubclassOfClass</span><span class="pun">:</span><span class="typ">MTLModel</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class=""> </span><span class="pln">createSignal</span><span class="pun">:</span><span class="pun">^</span><span class=""> </span><span class="pln">id</span><span class=""> </span><span class="pun">(</span><span class="pln">id</span><span class="pun">&lt;</span><span class="typ">RACSubscriber</span><span class="pun">&gt;</span><span class=""> </span><span class="pln">subscriber</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">void</span><span class=""> </span><span class="pun">(</span><span class="pun">^</span><span class="pln">parseJSONDictionary</span><span class="pun">)</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="typ">JSONDictionary</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">resultClass</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendNext</span><span class="pun">:</span><span class="typ">JSONDictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">error</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">OCTObject</span><span class=""> </span><span class="pun">*</span><span class="pln">parsedObject</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">MTLJSONAdapter</span><span class=""> </span><span class="pln">modelOfClass</span><span class="pun">:</span><span class="pln">resultClass</span><span class=""> </span><span class="pln">fromJSONDictionary</span><span class="pun">:</span><span class="typ">JSONDictionary</span><span class=""> </span><span class="pln">error</span><span class="pun">:</span><span class="pun">&amp;</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">parsedObject</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// Don&#39;t treat &#34;no class found&#34; errors as real parsing failures.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// In theory, this makes parsing code forward-compatible with</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// API additions.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">!</span><span class="pun">[</span><span class="pln">error</span><span class="pun">.</span><span class="pln">domain</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="typ">MTLJSONAdapterErrorDomain</span><span class="pun">]</span><span class=""> </span><span class="pun">|</span><span class="pun">|</span><span class=""> </span><span class="pln">error</span><span class="pun">.</span><span class="pln">code</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="typ">MTLJSONAdapterErrorNoClassFound</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendError</span><span class="pun">:</span><span class="pln">error</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pun">[</span><span class="pln">parsedObject</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">OCTObject</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;Parsed model object is not an OCTObject: %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">parsedObject</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="com">// Record the server that this object has come from.</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">parsedObject</span><span class="pun">.</span><span class="pln">baseURL</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">baseURL</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendNext</span><span class="pun">:</span><span class="pln">parsedObject</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">responseObject</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">NSArray</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">for</span><span class=""> </span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="typ">JSONDictionary</span><span class=""> </span><span class="kwd">in</span><span class=""> </span><span class="pln">responseObject</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">!</span><span class="pun">[</span><span class="typ">JSONDictionary</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">NSDictionary</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">failureReason</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Invalid JSON array element: %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class=""> </span><span class="typ">JSONDictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendError</span><span class="pun">:</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">parsingErrorWithFailureReason</span><span class="pun">:</span><span class="pln">failureReason</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">parseJSONDictionary</span><span class="pun">(</span><span class="typ">JSONDictionary</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendCompleted</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">responseObject</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">NSDictionary</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">parseJSONDictionary</span><span class="pun">(</span><span class="pln">responseObject</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendCompleted</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">responseObject</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendNext</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendCompleted</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">failureReason</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Response wasn&#39;t an array or dictionary (%@): %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class=""> </span><span class="pun">[</span><span class="pln">responseObject</span><span class=""> </span><span class="kwd">class</span><span class="pun">]</span><span class="pun">,</span><span class=""> </span><span class="pln">responseObject</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">subscriber</span><span class=""> </span><span class="pln">sendError</span><span class="pun">:</span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">parsingErrorWithFailureReason</span><span class="pun">:</span><span class="pln">failureReason</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">#</span><span class="pln">pragma</span><span class=""> </span><span class="pln">mark</span><span class=""> </span><span class="typ">Error</span><span class=""> </span><span class="typ">Handling</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">errorMessageFromErrorDictionary</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">errorDictionary</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">message</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorDictionary</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;message&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">resource</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorDictionary</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;resource&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">message</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34; %@ %@.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class=""> </span><span class="pln">resource</span><span class="pun">,</span><span class=""> </span><span class="pln">message</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">field</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorDictionary</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;field&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">codeType</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorDictionary</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;code&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class=""> </span><span class="pun">(</span><span class="pun">^</span><span class="pln">localizedErrorMessage</span><span class="pun">)</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">message</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pln">message</span><span class="pun">,</span><span class=""> </span><span class="pln">resource</span><span class="pun">,</span><span class=""> </span><span class="pln">field</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">codeString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">localizedErrorMessage</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ is missing&#34;</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">codeType</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;missing&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">codeString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">localizedErrorMessage</span><span class="pun">(</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ does not exist&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">codeType</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;missing_field&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">codeString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">localizedErrorMessage</span><span class="pun">(</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ is missing&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">codeType</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;invalid&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">codeString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">localizedErrorMessage</span><span class="pun">(</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ is invalid&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">codeType</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;already_exists&#34;</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">codeString</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">localizedErrorMessage</span><span class="pun">(</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@ %@ already exists&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34; %@.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pln">codeString</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">errorUserInfoFromRequestOperation</span><span class="pun">:</span><span class="pun">(</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">operation</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">operation</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">responseDictionary</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">operation</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">AFJSONRequestOperation</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">id</span><span class=""> </span><span class="typ">JSON</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">(</span><span class="typ">AFJSONRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">operation</span><span class=""> </span><span class="pln">responseJSON</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="typ">JSON</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">NSDictionary</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">responseDictionary</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">JSON</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSLog</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;Unexpected JSON for error response: %@&#34;</span><span class="pun">,</span><span class=""> </span><span class="typ">JSON</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">message</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">responseDictionary</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;message&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">errorDescription</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">message</span><span class=""> </span><span class="pun">?</span><span class="pun">:</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">error</span><span class="pun">.</span><span class="pln">localizedDescription</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">errorDescription</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">error</span><span class="pun">.</span><span class="pln">domain</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="typ">NSURLErrorDomain</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorDescription</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;There was a problem connecting to the server.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorDescription</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;The universe has collapsed.&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSArray</span><span class=""> </span><span class="pun">*</span><span class="pln">errorMessages</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSArray</span><span class=""> </span><span class="pun">*</span><span class="pln">errorDictionaries</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">responseDictionary</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;errors&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">errorDictionaries</span><span class=""> </span><span class="pln">isKindOfClass</span><span class="pun">:</span><span class="typ">NSArray</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">errors</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pun">[</span><span class="pln">errorDictionaries</span><span class="pun">.</span><span class="pln">rac_sequence</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">flattenMap</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">errorDictionary</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">message</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">errorMessageFromErrorDictionary</span><span class="pun">:</span><span class="pln">errorDictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">message</span><span class=""> </span><span class="pun">=</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSequence</span><span class=""> </span><span class="pln">empty</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class=""> </span><span class="kwd">else</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">RACSequence</span><span class=""> </span><span class="kwd">return</span><span class="pun">:</span><span class="pln">message</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">array</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">componentsJoinedByString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;\n&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">errorDescription</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSString</span><span class=""> </span><span class="pln">stringWithFormat</span><span class="pun">:</span><span class="typ">NSLocalizedString</span><span class="pun">(</span><span class="pun">@</span><span class="str">&#34;%@:\n\n%@&#34;</span><span class="pun">,</span><span class=""> </span><span class="pun">@</span><span class="str">&#34;&#34;</span><span class="pun">)</span><span class="pun">,</span><span class=""> </span><span class="pln">errorDescription</span><span class="pun">,</span><span class=""> </span><span class="pln">errors</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">errorMessages</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pun">[</span><span class="pln">errorDictionaries</span><span class="pun">.</span><span class="pln">rac_sequence</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">map</span><span class="pun">:</span><span class="pun">^</span><span class="pun">(</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">info</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">info</span><span class="pun">[</span><span class="pun">@</span><span class="str">&#34;message&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="pun">]</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">array</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">info</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pln">dictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">errorDescription</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">info</span><span class="pun">[</span><span class="typ">NSLocalizedDescriptionKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorDescription</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">message</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">info</span><span class="pun">[</span><span class="typ">OCTClientErrorDescriptionKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">message</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">errorMessages</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">info</span><span class="pun">[</span><span class="typ">OCTClientErrorMessagesKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorMessages</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">info</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSNumber</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">oneTimePasswordMediumFromHeader</span><span class="pun">:</span><span class="pun">(</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="typ">OTPHeader</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="com">// E.g., &#34;required; sms&#34;</span><span class="">
</span><span class="">	</span><span class="typ">NSArray</span><span class=""> </span><span class="pun">*</span><span class="pln">segments</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">OTPHeader</span><span class=""> </span><span class="pln">componentsSeparatedByString</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;;&#34;</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">segments</span><span class="pun">.</span><span class="pln">count</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="dec">2</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">status</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">segments</span><span class="pun">[</span><span class="dec">0</span><span class="pun">]</span><span class=""> </span><span class="pln">stringByTrimmingCharactersInSet</span><span class="pun">:</span><span class="typ">NSCharacterSet</span><span class="pun">.</span><span class="pln">whitespaceCharacterSet</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">medium</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="pln">segments</span><span class="pun">[</span><span class="dec">1</span><span class="pun">]</span><span class=""> </span><span class="pln">stringByTrimmingCharactersInSet</span><span class="pun">:</span><span class="typ">NSCharacterSet</span><span class="pun">.</span><span class="pln">whitespaceCharacterSet</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">status</span><span class=""> </span><span class="pln">caseInsensitiveCompare</span><span class="pun">:</span><span class="pun">@</span><span class="str">&#34;required&#34;</span><span class="pun">]</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="typ">NSOrderedSame</span><span class="pun">)</span><span class=""> </span><span class="kwd">return</span><span class=""> </span><span class="kwd">nil</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">mediumStringToWrappedMedium</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;sms&#34;</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientOneTimePasswordMediumSMS</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">@</span><span class="str">&#34;app&#34;</span><span class="pun">:</span><span class=""> </span><span class="pun">@</span><span class="pun">(</span><span class="typ">OCTClientOneTimePasswordMediumApp</span><span class="pun">)</span><span class="pun">,</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pln">mediumStringToWrappedMedium</span><span class="pun">[</span><span class="pln">medium</span><span class="pun">.</span><span class="pln">lowercaseString</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">+</span><span class=""> </span><span class="pun">(</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">errorFromRequestOperation</span><span class="pun">:</span><span class="pun">(</span><span class="typ">AFHTTPRequestOperation</span><span class=""> </span><span class="pun">*</span><span class="pun">)</span><span class="pln">operation</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="typ">NSParameterAssert</span><span class="pun">(</span><span class="pln">operation</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSInteger</span><span class=""> </span><span class="typ">HTTPCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusCode</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">userInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="typ">NSMutableDictionary</span><span class=""> </span><span class="pln">dictionary</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="typ">NSInteger</span><span class=""> </span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorConnectionFailed</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSDictionary</span><span class=""> </span><span class="pun">*</span><span class="pln">errorInfo</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">errorUserInfoFromRequestOperation</span><span class="pun">:</span><span class="pln">operation</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">[</span><span class="pln">userInfo</span><span class=""> </span><span class="pln">addEntriesFromDictionary</span><span class="pun">:</span><span class="pln">errorInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">switch</span><span class=""> </span><span class="pun">(</span><span class="typ">HTTPCode</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="dec">401</span><span class="pun">:</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSError</span><span class=""> </span><span class="pun">*</span><span class="pln">errorTemplate</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">authenticationRequiredError</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">errorTemplate</span><span class="pun">.</span><span class="pln">code</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">[</span><span class="pln">userInfo</span><span class=""> </span><span class="pln">addEntriesFromDictionary</span><span class="pun">:</span><span class="pln">errorTemplate</span><span class="pun">.</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="typ">NSNumber</span><span class=""> </span><span class="pun">*</span><span class="pln">wrappedMedium</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">[</span><span class="kwd">self</span><span class=""> </span><span class="pln">oneTimePasswordMediumFromHeader</span><span class="pun">:</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">allHeaderFields</span><span class="pun">[</span><span class="typ">OCTClientOneTimePasswordHeaderField</span><span class="pun">]</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">wrappedMedium</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorTwoFactorAuthenticationOneTimePasswordRequired</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorOneTimePasswordMediumKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">wrappedMedium</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">break</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="dec">400</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorBadRequest</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">break</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="dec">403</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorRequestForbidden</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">break</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="dec">422</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorServiceRequestFailed</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">break</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="kwd">default</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pun">[</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">error</span><span class="pun">.</span><span class="pln">domain</span><span class=""> </span><span class="pln">isEqual</span><span class="pun">:</span><span class="typ">NSURLErrorDomain</span><span class="pun">]</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">switch</span><span class=""> </span><span class="pun">(</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">error</span><span class="pun">.</span><span class="pln">code</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorSecureConnectionFailed</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorServerCertificateHasBadDate</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorServerCertificateHasUnknownRoot</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorServerCertificateUntrusted</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorServerCertificateNotYetValid</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorClientCertificateRejected</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">case</span><span class=""> </span><span class="typ">NSURLErrorClientCertificateRequired</span><span class="pun">:</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorSecureConnectionFailed</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="kwd">break</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorRequestStateRedirected</span><span class="pun">]</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pun">{</span><span class="">
</span><span class="">	</span><span class="">	</span><span class="pln">errorCode</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="typ">OCTClientErrorUnsupportedServerScheme</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorHTTPStatusCodeKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pun">@</span><span class="pun">(</span><span class="typ">HTTPCode</span><span class="pun">)</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="typ">URL</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorRequestURLKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">operation</span><span class="pun">.</span><span class="pln">error</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">NSUnderlyingErrorKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">error</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="typ">NSString</span><span class=""> </span><span class="pun">*</span><span class="pln">scopes</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">operation</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">allHeaderFields</span><span class="pun">[</span><span class="typ">OCTClientOAuthScopesHeaderField</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="">	</span><span class="kwd">if</span><span class=""> </span><span class="pun">(</span><span class="pln">scopes</span><span class=""> </span><span class="pun">!</span><span class="pun">=</span><span class=""> </span><span class="kwd">nil</span><span class="pun">)</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">[</span><span class="typ">OCTClientErrorOAuthScopesStringKey</span><span class="pun">]</span><span class=""> </span><span class="pun">=</span><span class=""> </span><span class="pln">scopes</span><span class="pun">;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="kwd">return</span><span class=""> </span><span class="pun">[</span><span class="typ">NSError</span><span class=""> </span><span class="pln">errorWithDomain</span><span class="pun">:</span><span class="typ">OCTClientErrorDomain</span><span class=""> </span><span class="pln">code</span><span class="pun">:</span><span class="pln">errorCode</span><span class=""> </span><span class="pln">userInfo</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">]</span><span class="pun">;</span><span class="">
</span><span class="pun">}</span><span class="">
</span><span class="">
</span><span class="pun">@</span><span class="kwd">end</span><span class="">
</span>
