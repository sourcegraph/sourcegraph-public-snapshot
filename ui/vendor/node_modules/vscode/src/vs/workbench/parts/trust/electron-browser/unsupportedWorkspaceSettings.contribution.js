/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
'use strict';
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var nls = require("vs/nls");
var lifecycle_1 = require("vs/base/common/lifecycle");
var winjs_base_1 = require("vs/base/common/winjs.base");
var actions_1 = require("vs/base/common/actions");
var contributions_1 = require("vs/workbench/common/contributions");
var platform_1 = require("vs/platform/platform");
var lifecycle_2 = require("vs/platform/lifecycle/common/lifecycle");
var message_1 = require("vs/platform/message/common/message");
var preferences_1 = require("vs/workbench/parts/preferences/common/preferences");
var configuration_1 = require("vs/workbench/services/configuration/common/configuration");
var telemetry_1 = require("vs/platform/telemetry/common/telemetry");
var storage_1 = require("vs/platform/storage/common/storage");
var UnsupportedWorkspaceSettingsContribution = (function () {
    function UnsupportedWorkspaceSettingsContribution(lifecycleService, workspaceConfigurationService, preferencesService, messageService, telemetryService, storageService) {
        var _this = this;
        this.workspaceConfigurationService = workspaceConfigurationService;
        this.preferencesService = preferencesService;
        this.messageService = messageService;
        this.telemetryService = telemetryService;
        this.storageService = storageService;
        this.toDispose = [];
        this.isUntrusted = false;
        lifecycleService.onShutdown(this.dispose, this);
        this.toDispose.push(this.workspaceConfigurationService.onDidUpdateConfiguration(function (e) { return _this.checkWorkspaceSettings(); }));
    }
    UnsupportedWorkspaceSettingsContribution.prototype.getId = function () {
        return 'unsupportedWorkspaceSettings';
    };
    UnsupportedWorkspaceSettingsContribution.prototype.dispose = function () {
        this.toDispose = lifecycle_1.dispose(this.toDispose);
    };
    UnsupportedWorkspaceSettingsContribution.prototype.checkWorkspaceSettings = function () {
        if (this.isUntrusted) {
            return;
        }
        var configurationKeys = this.workspaceConfigurationService.getUnsupportedWorkspaceKeys();
        this.isUntrusted = configurationKeys.length > 0;
        if (this.isUntrusted && !this.hasShownWarning()) {
            this.showWarning(configurationKeys);
        }
    };
    UnsupportedWorkspaceSettingsContribution.prototype.hasShownWarning = function () {
        return this.storageService.getBoolean(UnsupportedWorkspaceSettingsContribution.storageKey, storage_1.StorageScope.WORKSPACE, false);
    };
    UnsupportedWorkspaceSettingsContribution.prototype.rememberWarningWasShown = function () {
        this.storageService.store(UnsupportedWorkspaceSettingsContribution.storageKey, true, storage_1.StorageScope.WORKSPACE);
    };
    UnsupportedWorkspaceSettingsContribution.prototype.showWarning = function (unsupportedKeys) {
        var _this = this;
        var message = nls.localize('unsupportedWorkspaceSettings', 'This Workspace contains settings that can only be set in User Settings. ({0})', unsupportedKeys.join(', '));
        var openWorkspaceSettings = new actions_1.Action('unsupportedWorkspaceSettings.openWorkspaceSettings', nls.localize('openWorkspaceSettings', 'Open Workspace Settings'), '', true, function () {
            _this.telemetryService.publicLog('workspace.settings.unsupported.review');
            _this.rememberWarningWasShown();
            return _this.preferencesService.openWorkspaceSettings();
        });
        var openDocumentation = new actions_1.Action('unsupportedWorkspaceSettings.openDocumentation', nls.localize('openDocumentation', 'Learn More'), '', true, function () {
            _this.telemetryService.publicLog('workspace.settings.unsupported.documentation');
            _this.rememberWarningWasShown();
            window.open('https://go.microsoft.com/fwlink/?linkid=839878'); // Don't change link.
            return winjs_base_1.TPromise.as(true);
        });
        var close = new actions_1.Action('unsupportedWorkspaceSettings.Ignore', nls.localize('ignore', 'Ignore'), '', true, function () {
            _this.telemetryService.publicLog('workspace.settings.unsupported.ignore');
            _this.rememberWarningWasShown();
            return winjs_base_1.TPromise.as(true);
        });
        var actions = [openWorkspaceSettings, openDocumentation, close];
        this.messageService.show(message_1.Severity.Warning, { message: message, actions: actions });
        this.telemetryService.publicLog('workspace.settings.unsupported.warning');
    };
    return UnsupportedWorkspaceSettingsContribution;
}());
UnsupportedWorkspaceSettingsContribution.storageKey = 'workspace.settings.unsupported.warning';
UnsupportedWorkspaceSettingsContribution = __decorate([
    __param(0, lifecycle_2.ILifecycleService),
    __param(1, configuration_1.IWorkspaceConfigurationService),
    __param(2, preferences_1.IPreferencesService),
    __param(3, message_1.IMessageService),
    __param(4, telemetry_1.ITelemetryService),
    __param(5, storage_1.IStorageService)
], UnsupportedWorkspaceSettingsContribution);
var workbenchRegistry = platform_1.Registry.as(contributions_1.Extensions.Workbench);
workbenchRegistry.registerWorkbenchContribution(UnsupportedWorkspaceSettingsContribution);
